# Сводная AD / MFA / Кадры — веб-приложение

Веб-приложение для загрузки выгрузок из AD, MFA и кадровой системы в БД и просмотра сводной аналитической таблицы с сверкой данных (email, телефон, ФИО).

Все пути в скриптах заданы относительно каталога, в который клонирован репозиторий.

---

## Запуск на Ubuntu (рекомендуется)

После клонирования репозитория из корня проекта:

```bash
# Первый запуск или обычный старт
./install.sh

# Обновление из GitHub и пересборка контейнера (с кэшем, быстро)
./install.sh update
```

Скрипт создаёт каталог `data/` в корне проекта (если его ещё нет), собирает образ и запускает контейнер. **БД и настройки приложения** хранятся в папке **`data/`** на сервере, а не внутри контейнера.

Приложение: **http://localhost:3456**

Чтобы при клонировании на Linux скрипт уже был исполняемым, в репозитории должен быть сохранён атрибут исполнения. Один раз выполните (после добавления `install.sh`):

```bash
git add install.sh
git update-index --chmod=+x install.sh
git commit -m "Add executable install script"
```

После этого при `git clone` на Ubuntu файл `install.sh` будет с правом на выполнение.

---

## Что не попадает в GitHub

- Папка **`tmp/`** — примеры выгрузок (добавлена в `.gitignore`).
- Папка **`data/`** — БД и локальные настройки (создаётся при первом запуске, в репозиторий не коммитится).

---

## Запуск через Docker вручную

Из корня проекта:

```bash
mkdir -p data
docker compose up -d --build
```

Остановка: `docker compose down` (данные в `data/` сохраняются).

---

## Запуск без Docker (локально)

Из корня проекта:

```bash
pip install -r app/requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

БД в этом случае создаётся в `app/data/` (или по переменной окружения `DATABASE_URL`).

---

## Использование

1. **Загрузка файлов** — по очереди загрузите три типа выгрузок:
   - **AD** — CSV или Excel (логины, домен, статус УЗ, даты пароля, StaffUUID и т.д.).
   - **MFA** — CSV с разделителем «;» (Identity, Email, Name, Phones, LastLoginDate, CreatedAt, IsEnrolled, Authenticators).
   - **Кадры** — Excel, первый лист (StaffUUID, ФИО, Email, Телефон).

2. **Сводная таблица** — строится автоматически после загрузки. Связи: AD ↔ кадры по StaffUUID, AD ↔ MFA по логину (Identity). В таблице отображаются все записи из всех источников и колонка «Расхождения» при несовпадении данных между системами.

3. **Поиск** — поле «Поиск по таблице» фильтрует строки без перезагрузки страницы.

## Настройка колонок

Если названия колонок в выгрузках отличаются от ожидаемых, измените маппинг в `app/config.py` (AD_COLUMNS, MFA_COLUMNS, PEOPLE_COLUMNS, PEOPLE_EXTRA_COLUMNS).
